Анализ и сравнение проектов

═══════════════════════════════════════════════════════════════════════
1. АНАЛИЗ РЕПОЗИТОРИЯ freebotsigur
═══════════════════════════════════════════════════════════════════════

Название: Free Bot Sigur
Язык: Java 17
Фреймворк: Spring Boot 3.3.2
Назначение: Backend REST API сервис (Java-переписание .NET сервиса)

СТЕК ТЕХНОЛОГИЙ:
- Spring Web (REST API)
- Spring Data JPA (работа с БД)
- Spring Data Redis (кеширование)
- Spring Mail (SMTP)
- Flyway (миграции БД)
- Springdoc OpenAPI (документация API)
- PostgreSQL & MSSQL

СТРУКТУРА ПРОЕКТА:
src/main/java/com/freebotsigur/
├── FreeBotSigurApplication.java (точка входа)
├── application/
│   ├── commands/ (команды для админ-операций)
│   ├── dto/ (Data Transfer Objects)
│   └── services/ (бизнес-логика)
├── common/
│   ├── exceptions/ (кастомные исключения)
│   └── web/ (глобальная обработка ошибок)
├── config/ (конфигурационные свойства)
└── web/ (REST контроллеры и interceptor)

API ENDPOINTS (REST):
Admin Panel:
- POST /api/admin-panel/update-access
- POST /api/admin-panel/update-order

Builders (Подрядчики):
- GET /api/builders/persons-info/{projectId}/today
- GET /api/builders/persons-info/{projectId}/yesterday

Employees (Сотрудники ОСНОВА):
- GET /api/employees/osnova-info/{projectId}/today
- GET /api/employees/osnova-info/{projectId}/yesterday

Projects:
- GET /api/projects

Statistics:
- GET /api/statistics/attendance/{id}
- GET /api/statistics/board

Service Operations:
- GET /api/service/update-yesterday-data

Health Check:
- GET /api/healthcheck

Users:
- GET /api/users/has-access?userPhone={phone}

АВТОРИЗАЦИЯ:
- Interceptor требует заголовок Authorization для большинства эндпоинтов
- Публичные эндпоинты: /api/healthcheck, /api/users/has-access, /api/statistics/attendance/*

СОСТОЯНИЕ РЕАЛИЗАЦИИ:
✅ REST контроллеры
✅ DTO модели
✅ Структура сервисов
✅ Обработка ошибок (GlobalExceptionHandler)
✅ Управление конфигурацией
✅ Authorization interceptor

⏳ Бизнес-логика в сервисах (заглушки)
⏳ Доменные модели и JPA репозитории
⏳ Миграции Flyway
⏳ Интеграции (Sigur, Ast, Redis, SMTP)

КОНФИГУРАЦИЯ (application.yml):
- server.port
- spring.datasource (PostgreSQL/MSSQL)
- spring.data.redis
- spring.mail (SMTP)
- app.settings (is-test-env, sigur-cron-schedule)
- app.sigur (host, username, password)
- app.ast (host, username, password)
- app.smtp (sender-name, sender-email)


═══════════════════════════════════════════════════════════════════════
2. СРАВНЕНИЕ С ПРОЕКТОМ Service freebot (Python)
═══════════════════════════════════════════════════════════════════════

┌─────────────────────────┬──────────────────────────┬───────────────────────────┐
│ ПАРАМЕТР                │ freebotsigur (Java)      │ Service freebot (Python)  │
├─────────────────────────┼──────────────────────────┼───────────────────────────┤
│ Язык                    │ Java 17                  │ Python 3.11               │
│ Фреймворк               │ Spring Boot 3.3.2        │ python-telegram-bot 20.6  │
│ Тип приложения          │ Backend REST API         │ Telegram Bot (клиент)     │
│ База данных             │ PostgreSQL/MSSQL         │ MongoDB                   │
│ Авторизация             │ Authorization header     │ Telegram контакт          │
│ Кеширование             │ Redis                    │ Нет                       │
│ Контейнеризация         │ Не указано               │ Docker + docker-compose   │
│ CI/CD                   │ Не указано               │ GitLab CI + Azure         │
└─────────────────────────┴──────────────────────────┴───────────────────────────┘

АРХИТЕКТУРНАЯ РОЛЬ:
┌──────────────────────┐         HTTP API          ┌──────────────────────┐
│  Service freebot     │ ───────────────────────> │   freebotsigur       │
│  (Python Telegram    │      Authorization:       │   (Java Backend      │
│   Bot - Frontend)    │      phone_number         │    REST API)         │
└──────────────────────┘                           └──────────────────────┘
         │                                                   │
         │ хранит состояние                                 │ бизнес-логика
         │ пользователя                                     │ интеграции
         v                                                   v
   ┌────────────┐                                    ┌──────────────┐
   │  MongoDB   │                                    │ PostgreSQL/  │
   │ (состояние)│                                    │ MSSQL + Redis│
   └────────────┘                                    └──────────────┘


ВЗАИМОДЕЙСТВИЕ API:

Service freebot ВЫЗЫВАЕТ freebotsigur для:

1. Проверка доступа пользователя:
   backend.py: has_access() → GET /api/users/has-access?userPhone={phone}

2. Получение списка проектов:
   backend.py: _backend_get_projects() → GET /api/projects

3. Статистика по подрядчикам (сегодня):
   backend.py: _get_project_today() → GET /api/builders/persons-info/{projectId}/today

4. Статистика по подрядчикам (вчера):
   backend.py: _get_project_yesterday() → GET /api/builders/persons-info/{projectId}/yesterday

5. Статистика по сотрудникам ОСНОВА (сегодня):
   backend.py: _get_osnova_today() → GET /api/employees/osnova-info/{projectId}/today

6. Статистика по сотрудникам ОСНОВА (вчера):
   backend.py: _get_osnova_yesterday() → GET /api/employees/osnova-info/{projectId}/yesterday


СОВМЕСТИМОСТЬ API:
✅ Все эндпоинты, которые использует Python бот, ПРИСУТСТВУЮТ в Java backend
✅ Структура URL полностью совпадает
✅ Методы HTTP совпадают (GET)
✅ Авторизация: Python передает phone_number в заголовке Authorization


РАЗЛИЧИЯ В ДАННЫХ:

Python бот ожидает от Java backend:

1. GET /api/projects:
   Python ожидает: [{"id": int, "name": str}, ...]
   Java возвращает: List<GetProjectDto> {id: Long, name: String}
   ✅ СОВМЕСТИМО

2. GET /api/users/has-access:
   Python ожидает: boolean
   Java возвращает: boolean
   ✅ СОВМЕСТИМО

3. GET /api/builders/persons-info/{projectId}/today:
   Python ожидает: {projectName, statistics[], summaryPersonsCount, buttonPasses, unlockedPasses}
   Java возвращает: GetCurrentProjectBuildersDto {lots[], totalPersons}
   ⚠️ НЕСОВМЕСТИМО - структура различается!

4. GET /api/builders/persons-info/{projectId}/yesterday:
   Python ожидает: {projectName, statistics[], summaryPersonsCount, summaryPersonsPerDay, buttonPasses, unlockedPasses}
   Java возвращает: GetPerDayProjectBuildersDto {lots[], totalPersons, personDays}
   ⚠️ НЕСОВМЕСТИМО - структура различается!

5. GET /api/employees/osnova-info/{projectId}/today:
   Python ожидает: {projectName, employees[{fullName, arrivalTime}]}
   Java возвращает: GetEmployeesInfoDto<GetEmployeeCurrentInfoDto> {items[], totalCount}
   ⚠️ НЕСОВМЕСТИМО - структура различается!


═══════════════════════════════════════════════════════════════════════
3. ПЛАН ИНТЕГРАЦИОННОГО ТЕСТИРОВАНИЯ
═══════════════════════════════════════════════════════════════════════

ЭТАП 1: ПОДГОТОВКА ОКРУЖЕНИЯ
□ Поднять Java backend (freebotsigur) локально или на тестовом сервере
□ Настроить переменные окружения для Java backend
□ Настроить Python bot для подключения к Java backend
□ Убедиться в доступности всех сервисов (БД, Redis для Java)

ЭТАП 2: ТЕСТЫ ДОСТУПНОСТИ API
□ Проверить healthcheck: GET /api/healthcheck
□ Проверить доступность всех endpoint без авторизации (должны вернуть 405)
□ Проверить публичные endpoint (has-access, healthcheck)

ЭТАП 3: ТЕСТЫ АВТОРИЗАЦИИ
□ Проверить has-access с корректным номером телефона
□ Проверить has-access с некорректным номером
□ Проверить Authorization header в защищенных endpoint

ЭТАП 4: ИНТЕГРАЦИОННЫЕ ТЕСТЫ
□ Тест 1: Регистрация пользователя через бот
  - Отправить /start в Telegram
  - Поделиться контактом
  - Проверить вызов has-access API
  
□ Тест 2: Получение списка проектов
  - Нажать "Выбрать проект"
  - Проверить вызов GET /api/projects
  - Проверить отображение проектов в боте

□ Тест 3: Получение статистики (сегодня)
  - Выбрать проект
  - Нажать "Сейчас"
  - Проверить вызов GET /api/builders/persons-info/{id}/today
  - ⚠️ Проверить совместимость формата ответа

□ Тест 4: Получение статистики (вчера)
  - Нажать "Вчера"
  - Проверить вызов GET /api/builders/persons-info/{id}/yesterday
  - ⚠️ Проверить совместимость формата ответа

□ Тест 5: Режим ОСНОВА
  - Переключиться в режим ОСНОВА
  - Получить статистику сотрудников
  - ⚠️ Проверить совместимость формата ответа

ЭТАП 5: НАГРУЗОЧНЫЕ ТЕСТЫ
□ Одновременная работа нескольких пользователей
□ Проверка таймаутов (REQUEST_TIMEOUT = 10s)
□ Проверка поведения при недоступности backend

ЭТАП 6: ТЕСТЫ ОТКАЗОУСТОЙЧИВОСТИ
□ Backend недоступен (connection refused)
□ Backend возвращает 500
□ Backend возвращает некорректный JSON
□ Таймаут запроса


═══════════════════════════════════════════════════════════════════════
4. КРИТИЧЕСКИЕ ПРОБЛЕМЫ СОВМЕСТИМОСТИ
═══════════════════════════════════════════════════════════════════════

ПРОБЛЕМА 1: Несовпадение структуры DTO для статистики
Причина: Java backend возвращает упрощенные DTO (заглушки), Python бот ожидает полную структуру
Решение: 
  1. Дополнить DTO в Java backend (добавить projectName, statistics[], buttonPasses и т.д.)
  2. Или адаптировать Python код для работы с упрощенной структурой

ПРОБЛЕМА 2: Заголовок "osnova-access"
Python код: access_header = response.headers["osnova-access"]
Java backend: НЕ возвращает этот заголовок в GetProjectDto
Решение: Добавить заголовок в ProjectsController

ПРОБЛЕМА 3: Бизнес-логика не реализована в Java
Статус: Все сервисы в Java возвращают пустые объекты
Решение: Реализовать бизнес-логику или использовать mock-данные для тестирования


═══════════════════════════════════════════════════════════════════════
5. РЕКОМЕНДАЦИИ
═══════════════════════════════════════════════════════════════════════

КРАТКОСРОЧНЫЕ (для тестирования):
1. Создать mock-версию Java backend с реалистичными данными
2. Запустить оба сервиса в docker-compose для локального тестирования
3. Использовать Postman/curl для прямого тестирования API

СРЕДНЕСРОЧНЫЕ (для production):
1. Синхронизировать DTO между Java и Python проектами
2. Реализовать полную бизнес-логику в Java backend
3. Добавить интеграционные тесты (JUnit + TestContainers)
4. Настроить мониторинг и логирование

ДОЛГОСРОЧНЫЕ:
1. Рассмотреть использование единого API-контракта (OpenAPI/Swagger)
2. Внедрить версионирование API
3. Добавить Circuit Breaker для устойчивости к сбоям
4. Мигрировать Python бот на асинхронный HTTP клиент (httpx уже используется)
