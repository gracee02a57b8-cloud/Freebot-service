Полное описание проекта

Название
Service freebot (Telegram‑бот для просмотра статистики по проектам).

Назначение
Сервис предоставляет доступ к статистике по проектам через Telegram‑бота. Пользователь проходит авторизацию по номеру телефона, выбирает проект и получает статистику за сегодня/вчера. Для сотрудников ГК «Основа» доступен отдельный режим просмотра (OSNOVA).

Ключевые возможности
- Авторизация пользователя по номеру телефона (контакт из Telegram).
- Проверка доступа к данным через внешний backend API.
- Список доступных проектов и выбор проекта.
- Получение статистики «сейчас» и «вчера» по проекту.
- Отдельные отчёты для сотрудников ГК «Основа».
- Хранение состояния пользователя и справочников в MongoDB.

Архитектура и основные модули
1) Точка входа
- bot.py: инициализирует Telegram‑приложение, регистрирует handlers и запускает polling.

2) Обработка команд и сообщений
- handlers.py:
  - start(): запрашивает контакт пользователя.
  - get_contact_handler(): проверяет доступ и сохраняет номер.
  - projects(): запрашивает список проектов у backend и показывает кнопки.
  - project_today(), project_yesterday(): выдаёт статистику по проекту.
  - osnova_button(), constractor_button(): переключение режима статистики.
  - select_project_button(): обработка inline‑кнопки выбора проекта.
  - common_callback(): общий роутер текстовых сообщений.

3) Авторизация
- auth.py:
  - _check_auth(): проверка доступа через backend.
  - is_auth_user(): декоратор, гарантирующий наличие телефона в БД.

4) Интеграция с backend API
- backend.py:
  - _backend_get_projects(): получение проектов и флага доступа ОСНОВА.
  - _get_project_today()/yesterday(): статистика по подрядчикам.
  - _get_osnova_today()/yesterday(): статистика по сотрудникам.
  - has_access(): проверка доступа пользователя.

5) Хранение данных (MongoDB)
- db.py:
  - users: телефон, флаг сотрудника.
  - state: выбранный проект и режим (is_osnova).
  - projects: id и название проекта (кеш для отображения).

6) Формирование текстов сообщений
- messages.py:
  - Формирует Markdown‑сообщения для Telegram.
  - Форматирует времена и итоговые строки.

7) Клавиатуры Telegram
- keyboards.py:
  - Reply/Inline клавиатуры для кнопок выбора проекта и периода.

8) Конфигурация
- config.py:
  - Константы текстов, кнопок и regex.
  - Загрузка переменных окружения (.env).
  - Настройка логирования.

Запуск и окружение
- Запуск через Docker Compose: docker-compose up --build
- Приложению нужен внешний интернет для Telegram API.

Основные переменные окружения
(через .env или CI/CD переменные)
- TELEGRAM_TOKEN: токен Telegram‑бота.
- BACKEND_BASE_URL: базовый URL backend API.
- REQUEST_TIMEOUT: таймаут запросов к backend.
- MONGO_HOST, MONGO_PORT, MONGO_USERNAME, MONGO_PASSWORD, MONGO_NAME: доступ к MongoDB.

Сценарий работы пользователя
1) /start → бот предлагает «Поделиться контактом».
2) Пользователь отправляет контакт → проверка доступа через backend.
3) Бот сохраняет номер телефона в MongoDB.
4) Пользователь выбирает проект.
5) Бот показывает кнопки «Сейчас», «Вчера» и (если доступно) «ОСНОВА».
6) Пользователь получает статистику за выбранный период.

Интеграции
- Telegram Bot API: библиотека python-telegram-bot.
- Backend API: REST‑эндпоинты /api/projects, /api/builders/persons-info/*, /api/employees/osnova-info/*, /api/users/has-access.
- MongoDB: хранение состояния пользователя и справочников.

Docker и CI/CD
- Dockerfile: сборка образа Python 3.11, установка зависимостей, запуск bot.py.
- docker-compose.yml: сервисы bot и mongodb, переменные окружения и сеть.
- azure-pipelines.yml: CI (build/push) и CD (pull/run) через Docker Compose.

Зависимости
- python-telegram-bot==20.6
- httpx==0.25.0
- pymongo==4.6.0
- python-dotenv==1.0.0
- Доп. библиотеки для HTTP/утилит и форматирования (см. requirements.txt).

Файлы проекта (кратко)
- bot.py — точка входа.
- handlers.py — обработчики сообщений/кнопок.
- auth.py — авторизация и декоратор.
- backend.py — HTTP‑интеграция с backend.
- db.py — работа с MongoDB.
- keyboards.py — Telegram клавиатуры.
- messages.py — форматирование сообщений.
- config.py — конфигурация и тексты.
- Dockerfile, docker-compose.yml — контейнеризация.
- azure-pipelines.yml — CI/CD пайплайн.
- requirements.txt — зависимости.
- README.md — краткий запуск.
